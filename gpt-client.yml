import psycopg2  # New library for Postgres
    
    # Connect to the DB using the Service Name we created earlier
    def save_to_db(user_msg, gpt_resp):
        try:
            conn = psycopg2.connect(
                host="postgres", # This is the K8s service name!
                database="appdb",
                user="appuser",
                password="supersecretpassword"
            )
            cur = conn.cursor()
            cur.execute("CREATE TABLE IF NOT EXISTS chat_history (id SERIAL PRIMARY KEY, user_input TEXT, gpt_output TEXT, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);")
            cur.execute("INSERT INTO chat_history (user_input, gpt_output) VALUES (%s, %s)", (user_msg, gpt_resp))
            conn.commit()
            cur.close()
            conn.close()
        except Exception as e:
            print(f"Database error: {e}")

    @app.route("/", methods=["GET", "POST"])
    def chat():
        resp = None
        if request.method == "POST":
            user_msg = request.form.get("msg")
            completion = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": user_msg}]
            )
            resp = completion.choices[0].message.content
            save_to_db(user_msg, resp) # SAVE IT!
        return render_template_string(HTML, resp=resp)
